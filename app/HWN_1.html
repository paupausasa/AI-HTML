<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸«ä½œæ¥­æª¢æŸ¥å°å¹«æ‰‹ (è‡ªå‹•å­˜æª”ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333;
            --border: #dee2e6;
            
            /* æŒ‰éˆ•ç‹€æ…‹é¡è‰² */
            --btn-default-bg: #e9ecef;
            --btn-default-text: #495057;
            
            --btn-warn-bg: #fff3cd; /* é»ƒè‰² - æ²’è¨‚æ­£ */
            --btn-warn-text: #856404;
            --btn-warn-border: #ffeeba;
            
            --btn-danger-bg: #f8d7da; /* ç´…è‰² - æ²’å¯« */
            --btn-danger-text: #721c24;
            --btn-danger-border: #f5c6cb;
        }

        body {
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 900px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            position: relative;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            background: #fff;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }
        
        .btn-generate {
            background-color: #4a90e2;
        }
        
        .btn-generate:hover {
            background-color: #357abd;
        }

        .btn-clear {
            background-color: #dc3545;
            margin-left: auto; /* æ¨åˆ°æœ€å³é‚Š */
        }
        
        .btn-clear:hover {
            background-color: #c82333;
        }

        /* å­¸ç”Ÿåˆ—è¡¨å€å¡Š - å…©æ¬„å¼è¨­è¨ˆ */
        .student-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* å¼·åˆ¶å…©æ¬„ */
            gap: 15px;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 60px; /* ç•™çµ¦åº•éƒ¨æŒ‰éˆ•ç©ºé–“ */
        }
        
        @media (max-width: 768px) {
            .student-grid {
                grid-template-columns: 1fr; /* æ‰‹æ©Ÿç‰ˆæ”¹å›å–®æ¬„ */
            }
        }

        /* å–®ä¸€å­¸ç”Ÿåˆ— */
        .student-row {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: flex-start; /* å°é½Šé ‚éƒ¨ */
            gap: 10px;
        }

        .stu-num {
            background: #4a4a4a;
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1rem;
            flex-shrink: 0;
        }

        /* å€‹åˆ¥å·®ç•°è¼¸å…¥æ¡† */
        .individual-input {
            width: 50px;
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
            color: #555;
            margin-top: 2px; /* å¾®èª¿å°é½Š */
        }
        
        .individual-input:focus {
            border-color: #4a90e2;
            color: #000;
        }

        .individual-input::placeholder {
            color: #bbb;
            font-size: 0.8rem;
        }

        /* é ç¢¼æŒ‰éˆ•å®¹å™¨ */
        .page-btn-container {
            flex: 1;
            display: grid;
            /* æ¯åˆ— 5 å€‹æŒ‰éˆ• */
            grid-template-columns: repeat(5, 1fr); 
            gap: 5px;
        }

        /* é ç¢¼å°æŒ‰éˆ• */
        .page-btn {
            padding: 8px 2px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: var(--btn-default-bg);
            color: var(--btn-default-text);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: bold;
            text-align: center;
            user-select: none;
            transition: all 0.1s;
            position: relative;
            
            box-shadow: 0 2px 0 rgba(0,0,0,0.1); 
            transform: translateY(0);
            
            /* è®“é•·æ•¸å­—è‡ªå‹•ç¸®å°æˆ–æ›è¡Œ */
            word-break: break-all;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* ç‹€æ…‹æ¨£å¼ */
        .page-btn.state-1 { /* æ²’è¨‚æ­£ */
            background-color: var(--btn-warn-bg);
            color: var(--btn-warn-text);
            border-color: var(--btn-warn-border);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); 
            transform: translateY(2px); 
        }

        .page-btn.state-2 { /* æ²’å¯« */
            background-color: var(--btn-danger-bg);
            color: var(--btn-danger-text);
            border-color: var(--btn-danger-border);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); 
            transform: translateY(2px);
        }

        /* åŒ¯å‡ºæŒ‰éˆ•å€ */
        .export-section {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .btn-export {
            background-color: #28a745;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        
        .btn-export:hover {
            background-color: #218838;
        }

        .hint-text {
            color: #888;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .save-status {
            font-size: 0.8rem;
            color: #28a745;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <h2>ğŸ“ ä½œæ¥­æª¢æŸ¥å°å¹«æ‰‹ (è‡ªå‹•å­˜æª”ç‰ˆ)</h2>

    <div class="control-panel">
        <div class="input-group">
            <label>æ—¥æœŸ</label>
            <input type="date" id="dateInput" onchange="saveToStorage()">
        </div>

        <div class="input-group">
            <label>ç§‘ç›®</label>
            <select id="subjectSelect" onchange="saveToStorage()">
                <option value="åœ‹ç¿’">åœ‹ç¿’</option>
                <option value="æ•¸ç¿’">æ•¸ç¿’</option>
                <option value="ç¤¾ç¿’">ç¤¾ç¿’</option>
                <option value="è‡ªç¿’">è‡ªç¿’</option>
                <option value="ç”Ÿç”²">ç”Ÿç”²</option>
                <option value="ç”Ÿä¹™">ç”Ÿä¹™</option>
                <option value="æ•¸ä½œ">æ•¸ä½œ</option>
                <option value="åœˆè©">åœˆè©</option>
                <option value="é€ è©">é€ è©</option>
                <option value="ä½œæ–‡">ä½œæ–‡</option>
            </select>
        </div>

        <div class="input-group" style="flex: 2; min-width: 200px;">
            <label>çµ±ä¸€è¼¸å…¥é æ•¸ç¯„åœ (ä¾‹: 10-12)</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="pageRangeInput" placeholder="10-12" style="flex:1;">
                <button class="action-btn btn-generate" onclick="generateButtons()">ç¢ºèªä¸¦é‡ç½®å…¨ç­</button>
            </div>
            <div class="hint-text">
                å€‹åˆ¥å­¸ç”Ÿè‹¥ä¸åŒï¼Œè«‹ç›´æ¥åœ¨ä¸‹æ–¹è©²ç”Ÿæ¬„ä½è¼¸å…¥
                <span id="saveStatus" class="save-status">å·²å„²å­˜</span>
            </div>
        </div>

        <button class="action-btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
    </div>

    <div class="student-grid" id="studentGrid">
        <!-- å­¸ç”Ÿåˆ—è¡¨å°‡ç”± JS ç”Ÿæˆ -->
    </div>

    <div class="export-section">
        <button class="action-btn btn-export" onclick="exportToTxt()">ğŸ“¤ åŒ¯å‡º TXT</button>
    </div>

    <script>
        // è¨­å®šä»Šæ—¥æ—¥æœŸ (å¦‚æœæ²’æœ‰å­˜æª”çš„è©±)
        const dateInput = document.getElementById('dateInput');
        dateInput.valueAsDate = new Date();

        const totalStudents = 32;
        const studentGrid = document.getElementById('studentGrid');
        
        // è³‡æ–™çµæ§‹: { åº§è™Ÿ: { "é ç¢¼": ç‹€æ…‹ç¢¼ } }
        let classData = {};

        // åˆå§‹åŒ–: å˜—è©¦è®€å–å­˜æª”ï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºç©ºç™½
        window.onload = function() {
            loadFromStorage();
        }

        // ============================
        // æ ¸å¿ƒé‚è¼¯ï¼šå­˜æª”èˆ‡è®€æª”
        // ============================

        function saveToStorage() {
            const data = {
                date: document.getElementById('dateInput').value,
                subject: document.getElementById('subjectSelect').value,
                globalRange: document.getElementById('pageRangeInput').value,
                students: {}
            };

            for (let i = 1; i <= totalStudents; i++) {
                // å–å¾—å€‹åˆ¥è¼¸å…¥æ¡†çš„å€¼
                const manualInput = document.getElementById(`input-${i}`) ? document.getElementById(`input-${i}`).value : "";
                
                // å„²å­˜ç‹€æ…‹
                data.students[i] = {
                    manualInput: manualInput,
                    pages: classData[i] || {}
                };
            }

            localStorage.setItem('homeworkCheckerData_v2', JSON.stringify(data));
            
            // é¡¯ç¤ºå·²å„²å­˜æç¤º
            const status = document.getElementById('saveStatus');
            status.style.opacity = '1';
            setTimeout(() => { status.style.opacity = '0'; }, 1000);
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('homeworkCheckerData_v2');
            
            if (!saved) {
                renderEmptyGrid();
                return;
            }

            try {
                const data = JSON.parse(saved);
                
                // æ¢å¾©ä¸Šæ–¹è¨­å®š
                if(data.date) document.getElementById('dateInput').value = data.date;
                if(data.subject) document.getElementById('subjectSelect').value = data.subject;
                if(data.globalRange) document.getElementById('pageRangeInput').value = data.globalRange;

                // æ¢å¾©å­¸ç”Ÿåˆ—è¡¨
                studentGrid.innerHTML = '';
                classData = {};

                for (let i = 1; i <= totalStudents; i++) {
                    const studentInfo = data.students[i] || { manualInput: "", pages: {} };
                    
                    // æ¢å¾©è³‡æ–™
                    classData[i] = studentInfo.pages;
                    
                    // æ ¹æ“šå„²å­˜çš„é é¢è³‡æ–™é‡å»ºæŒ‰éˆ•æ¸…å–®
                    // æˆ‘å€‘ç›´æ¥ä½¿ç”¨å„²å­˜çš„ keysï¼Œé€™æ¨£å¯ä»¥ä¿ç•™ç•¶æ™‚çš„ç‹€æ…‹ (å³ä½¿æ˜¯è‡ªè¨‚çš„)
                    let pageList = Object.keys(studentInfo.pages).sort((a, b) => (parseInt(a)||0) - (parseInt(b)||0));
                    
                    // å»ºç«‹åˆ— (å‚³å…¥å„²å­˜çš„ manualInput)
                    const row = createStudentRow(i, pageList, studentInfo.manualInput);
                    studentGrid.appendChild(row);
                    
                    // æ¢å¾©æŒ‰éˆ•é¡è‰²ç‹€æ…‹
                    // å› ç‚º createStudentRow å·²ç¶“å»ºç«‹äº†æŒ‰éˆ•ï¼Œæˆ‘å€‘ç¾åœ¨å» DOM è£¡é¢æ‰¾å›ä¾†åŠ ä¸Š class
                    const container = document.getElementById(`btn-container-${i}`);
                    if (container) {
                        const btns = container.querySelectorAll('.page-btn');
                        btns.forEach(btn => {
                            const p = btn.textContent;
                            const s = classData[i][p];
                            if (s === 1) {
                                btn.classList.add('state-1');
                                btn.title = "æ²’è¨‚æ­£";
                            } else if (s === 2) {
                                btn.classList.add('state-2');
                                btn.title = "æ²’å¯«";
                            }
                        });
                    }
                }
            } catch (e) {
                console.error("è®€å–å­˜æª”å¤±æ•—ï¼Œé‡ç½®è³‡æ–™", e);
                renderEmptyGrid();
            }
        }

        function clearAllData() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™æœƒæ¸…ç©ºç›®å‰çš„é é¢ç‹€æ…‹ã€‚")) {
                localStorage.removeItem('homeworkCheckerData_v2');
                location.reload(); // é‡æ–°æ•´ç†é é¢
            }
        }

        // ============================
        // ä»‹é¢ç”Ÿæˆé‚è¼¯
        // ============================

        function renderEmptyGrid() {
            studentGrid.innerHTML = '';
            for (let i = 1; i <= totalStudents; i++) {
                classData[i] = {};
                const row = createStudentRow(i, []);
                studentGrid.appendChild(row);
            }
        }

        function parsePageRange(input) {
            let pages = new Set();
            if (!input) return [];

            const parts = input.split(/[,ï¼Œ\s]+/);
            
            parts.forEach(part => {
                if (part.includes('-') || part.includes('~')) {
                    const range = part.split(/[-~]/);
                    const start = parseInt(range[0]);
                    const end = parseInt(range[1]);
                    if (!isNaN(start) && !isNaN(end) && end >= start) {
                        for (let k = start; k <= end; k++) {
                            pages.add(k.toString());
                        }
                    }
                } else {
                    const num = part.trim();
                    if (num) pages.add(num);
                }
            });

            return Array.from(pages).sort((a, b) => (parseInt(a)||0) - (parseInt(b)||0));
        }

        // å…¨ç­çµ±ä¸€ç”Ÿæˆ
        function generateButtons() {
            const input = document.getElementById('pageRangeInput').value.trim();
            if (!input) {
                alert("è«‹å…ˆè¼¸å…¥é æ•¸ç¯„åœï¼Œä¾‹å¦‚ï¼š10-12");
                return;
            }

            const pageList = parsePageRange(input);
            if (pageList.length === 0) {
                alert("ç„¡æ³•è§£æé æ•¸ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚");
                return;
            }

            // æ¸…ç©ºç•«é¢ä¸¦é‡æ–°å»ºç«‹
            studentGrid.innerHTML = '';
            classData = {}; 

            for (let i = 1; i <= totalStudents; i++) {
                classData[i] = {};
                pageList.forEach(p => classData[i][p] = 0);
                
                // ç”¢ç”Ÿæ™‚ï¼Œå€‹åˆ¥è¼¸å…¥æ¡†é è¨­æ˜¯ç©ºçš„
                const row = createStudentRow(i, pageList, ""); 
                studentGrid.appendChild(row);
            }
            
            // å‹•ä½œå®Œæˆå¾Œå­˜æª”
            saveToStorage();
        }

        // é‡å°å–®ä¸€å­¸ç”Ÿæ›´æ–°æŒ‰éˆ•
        function updateStudentButtons(id, inputVal) {
            const container = document.getElementById(`btn-container-${id}`);
            if (!container) return;

            let pageList = [];
            
            if (inputVal.trim() === "") {
                const globalInput = document.getElementById('pageRangeInput').value.trim();
                pageList = parsePageRange(globalInput);
            } else {
                pageList = parsePageRange(inputVal);
            }

            classData[id] = {};
            pageList.forEach(p => classData[id][p] = 0);

            container.innerHTML = '';

            if (pageList.length === 0) {
                 container.innerHTML = '<span style="color:#ccc; font-size:0.9rem; margin-top:5px;">ç„¡é æ•¸</span>';
            } else {
                pageList.forEach(page => {
                    const btn = document.createElement('button');
                    btn.className = 'page-btn';
                    btn.textContent = page;
                    btn.onclick = () => toggleBtnState(id, page, btn);
                    container.appendChild(btn);
                });
            }
            
            // å‹•ä½œå®Œæˆå¾Œå­˜æª”
            saveToStorage();
        }

        function createStudentRow(id, pageList, manualValue = "") {
            const row = document.createElement('div');
            row.className = 'student-row';

            // 1. åº§è™Ÿ
            const numBox = document.createElement('div');
            numBox.className = 'stu-num';
            numBox.textContent = id;
            row.appendChild(numBox);

            // 2. å€‹åˆ¥å·®ç•°è¼¸å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'individual-input';
            input.placeholder = 'è‡ªè¨‚';
            input.id = `input-${id}`; // åŠ ä¸ŠIDæ–¹ä¾¿å­˜å–
            input.value = manualValue;
            input.onchange = function() {
                updateStudentButtons(id, this.value);
            };
            row.appendChild(input);

            // 3. æŒ‰éˆ•å®¹å™¨
            const btnContainer = document.createElement('div');
            btnContainer.className = 'page-btn-container';
            btnContainer.id = `btn-container-${id}`;

            if (pageList.length === 0) {
                btnContainer.innerHTML = '<span style="color:#ccc; font-size:0.9rem; align-self:center; margin-left:5px;">ç­‰å¾…è¼¸å…¥...</span>';
            } else {
                pageList.forEach(page => {
                    const btn = document.createElement('button');
                    btn.className = 'page-btn';
                    btn.textContent = page;
                    btn.onclick = () => toggleBtnState(id, page, btn);
                    btnContainer.appendChild(btn);
                });
            }

            row.appendChild(btnContainer);
            return row;
        }

        function toggleBtnState(stuId, page, btnElement) {
            let currentStatus = classData[stuId][page];
            // 0 -> 1 -> 2 -> 0
            let nextStatus = (currentStatus + 1) % 3;
            
            classData[stuId][page] = nextStatus;

            btnElement.classList.remove('state-1', 'state-2');
            
            if (nextStatus === 1) {
                btnElement.classList.add('state-1');
                btnElement.title = "æ²’è¨‚æ­£";
            } else if (nextStatus === 2) {
                btnElement.classList.add('state-2');
                btnElement.title = "æ²’å¯«";
            } else {
                btnElement.title = "OK";
            }
            
            // å‹•ä½œå®Œæˆå¾Œå­˜æª”
            saveToStorage();
        }

        // ============================
        // åŒ¯å‡ºé‚è¼¯
        // ============================

        function formatPages(pageArray) {
            if (pageArray.length === 0) return "";
            const nums = pageArray.map(p => parseInt(p)).filter(n => !isNaN(n)).sort((a, b) => a - b);
            if (nums.length === 0) return pageArray.join('/');

            let result = [];
            let start = nums[0];
            let prev = nums[0];

            for (let i = 1; i < nums.length; i++) {
                if (nums[i] === prev + 1) {
                    prev = nums[i];
                } else {
                    if (start === prev) {
                        result.push(start);
                    } else {
                        result.push(`${start}-${prev}`);
                    }
                    start = nums[i];
                    prev = nums[i];
                }
            }
            if (start === prev) {
                result.push(start);
            } else {
                result.push(`${start}-${prev}`);
            }

            return result.join('/');
        }

        function exportToTxt() {
            const date = document.getElementById('dateInput').value;
            const subject = document.getElementById('subjectSelect').value;
            
            let content = `æ—¥æœŸï¼š${date}\nç§‘ç›®ï¼š${subject}\n\n`;
            let hasRecord = false;

            for (let i = 1; i <= totalStudents; i++) {
                const pagesObj = classData[i];
                if (!pagesObj) continue;

                let uncorrected = []; 
                let unwritten = [];

                Object.keys(pagesObj).forEach(page => {
                    const status = pagesObj[page];
                    if (status === 1) uncorrected.push(page);
                    if (status === 2) unwritten.push(page);
                });

                if (uncorrected.length === 0 && unwritten.length === 0) continue;

                hasRecord = true;
                const numStr = i.toString().padStart(2, '0');
                
                let parts = [];
                if (uncorrected.length > 0) {
                    parts.push(`æ²’è¨‚æ­£ï¼š${formatPages(uncorrected)}`);
                }
                if (unwritten.length > 0) {
                    parts.push(`è¦è£œå¯«ï¼š${formatPages(unwritten)}`);
                }

                if (parts.length > 0) {
                    content += `ï¼»${numStr}ï¼½${parts.join('ï¼›')}ã€‚\n`;
                }
            }

            if (!hasRecord) {
                alert("å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰ä»»ä½•éœ€è¦åŒ¯å‡ºçš„ç´€éŒ„ã€‚");
                return;
            }

            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${date}_${subject}_æª¢æŸ¥ç´€éŒ„.txt`;
            link.click();
            setTimeout(() => URL.revokeObjectURL(link.href), 100);
        }
    </script>
</body>
</html>
