<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紫微斗數專業疊宮版 - 水平排列與精緻四化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700;900&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    colors: {
                        'paper-bg': '#fcfcf7', 
                        'paper-panel': '#f5f5f0', 
                        'paper-border': '#dcd6cc', 
                        'ink-main': '#2c2c2c', 
                        'accent-gold': '#b45309', 
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fcfcf7;
            color: #2c2c2c;
            overflow: hidden; 
        }

        /* 卷軸美化 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }

        /* --- 核心佈局 --- */
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
            .main-container { flex-direction: row; }
        }

        /* 宮位網格 (自適應視窗) */
        .palace-grid-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 8px;
            overflow: hidden;
        }

        .palace-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 4px;
            width: 96vmin; 
            height: 96vmin;
            max-width: 850px;
            max-height: 850px;
            background-color: #e7e5e4;
            border: 3px double #57534e; 
            padding: 3px;
        }

        .palace-cell {
            background-color: #ffffff;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 4px;
            overflow: hidden;
            transition: all 0.15s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .palace-cell:hover { border-color: #b45309; z-index: 10; }
        
        /* 高亮樣式 */
        .palace-cell.highlight-target, .palace-cell.highlight-dui {
            background-color: #eff6ff; box-shadow: inset 0 0 0 2px #60a5fa;
        }
        .palace-cell.highlight-sanhe {
            background-color: #fefce8; box-shadow: inset 0 0 0 2px #facc15;
        }

        /* 中宮 */
        .center-area {
            grid-area: 2 / 2 / 4 / 4;
            background-color: #fcfcf7;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            position: relative;
            z-index: 5;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .center-decor {
            position: absolute; inset: 6px; border: 1px solid #d6d3d1; pointer-events: none; z-index: 0;
        }

        /* 地支浮水印 */
        .branch-watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: "Noto Serif TC", serif; font-size: 3rem; color: #f5f5f4;
            font-weight: 900; pointer-events: none; z-index: 0; opacity: 0.8;
        }

        /* 宮職標籤 */
        .palace-header {
            display: flex; flex-wrap: wrap; gap: 1px; margin-bottom: 2px; z-index: 1; min-height: 1rem;
        }
        .palace-label {
            font-size: 0.65rem; padding: 0px 2px; border-radius: 2px;
            font-family: "Noto Serif TC", serif; font-weight: bold; line-height: 1.2;
            border: 1px solid; white-space: nowrap;
        }
        /* 宮職標籤顏色 */
        .label-ben { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
        .label-da { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        .label-nian { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        .label-yue { background: #faf5ff; color: #7e22ce; border-color: #e9d5ff; }
        .label-ri { background: #fff7ed; color: #c2410c; border-color: #fed7aa; }

        /* --- 星曜與四化排版 --- */
        
        .palace-stars {
            display: flex;
            flex-direction: row; /* 水平排列星群 */
            flex-wrap: wrap;     
            align-content: flex-start;
            justify-content: flex-start;
            z-index: 1;
            flex: 1;
            padding-bottom: 1.2rem;
            overflow: hidden;
            gap: 4px 6px;
        }

        /* 單個星曜組：星在上，四化在下 */
        .star-group {
            display: flex;
            flex-direction: column;   /* 星曜上、四化下 */
            align-items: center;
            width: max-content;
            gap: 1px;
        }

        /* 星曜本體樣式基礎（盤面用） */
        .star-item {
            font-size: 0.85rem;
            font-family: "Noto Serif TC", serif;
            line-height: 1.2;
            cursor: grab;
            transition: transform 0.1s;
            white-space: nowrap;

            /* 盤面星曜直書 */
            writing-mode: vertical-rl;
            text-orientation: upright;
        }
        .star-item:hover { transform: scale(1.1); z-index: 20; }
        .star-item.dragging { opacity: 0.5; }

        /* --- 四化標籤樣式 --- */
        
        .sihua-container {
            display: flex;
            flex-direction: column;  /* 四化依時間層級由上往下排 */
            gap: 1px;
            margin-top: 0;
        }

        .sihua-tag {
            position: relative;
            font-family: "Noto Serif TC", serif;
            font-size: 0.6rem;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-width: 1px;
            border-style: solid;
            border-radius: 2px;
            line-height: 1;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }

        /* 四化字體顏色 */
        .text-lu { color: #008000; font-weight: 900; } /* 祿 */
        .text-quan { color: #800000; font-weight: 900; } /* 權 */
        .text-ke { color: #0000ff; font-weight: 900; } /* 科 */
        .text-ji { color: #800000; font-weight: 900; } /* 忌 */

        /* 四化框線顏色 + 背景顏色（按時間層級） */
        .border-ben { border-color: #000000; background-color: #FFD2D2; } /* 生年 */
        .border-da  { border-color: #006400; background-color: #C1FFE4; } /* 大限 */
        .border-nian{ border-color: #0000ff; background-color: #C4E1FF; } /* 流年 */
        .border-yue { border-color: #ffa500; background-color: #FFDCB9; } /* 流月 */
        .border-ri  { border-color: #800080; background-color: #DAB1D5; } /* 流日 */

        /* 左上角層級標示 (偽元素) */
        .sihua-tag::before {
            content: attr(data-layer);
            position: absolute;
            top: -4px;
            left: -4px;
            font-size: 0.45rem;
            transform: scale(0.85);
            background-color: #fff;
            padding: 0 1px;
            color: #555;
            font-family: "Inter", sans-serif;
            font-weight: bold;
            line-height: 1;
            border-radius: 2px;
        }

        /* --- 星曜顏色定義（依你指定的色碼） --- */
        .style-major { 
            font-weight: 700; 
            color: #796400;   /* 主星：褐色粗體 */
        } 
        .style-blue { 
            font-weight: 700; 
            color: #0000C6;   /* 天魁、天鉞、左輔、右弼：深藍 */
        }
        .style-green { 
            font-weight: 700; 
            color: #01814A;   /* 文昌、文曲、祿存、天馬：深綠 */
        }
        .style-pink { 
            font-weight: 600; 
            color: #db2777; 
        }
        .style-black-bg { 
            background-color: #111827; 
            color: #ffffff; 
            border-radius: 2px; 
            padding: 0 2px; 
        }
        .style-gray-bg { 
            background-color: #e5e7eb; 
            color: #000000; 
            border-radius: 2px; 
            padding: 0 2px; 
            font-weight: 600; 
        }

        /* 右下角地支 */
        .corner-branch {
            position: absolute; bottom: 1px; right: 2px;
            font-family: "Noto Serif TC", serif; font-weight: 700; color: #a8a29e;
            font-size: 0.9rem; z-index: 1; opacity: 0.6;
        }

        /* 側邊欄與備選區 */
        .layer-tab.active { border-bottom-width: 2px; }
        .star-pool-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 6px; 
            padding: 8px;
        }
        .star-pool-item {
            font-family: "Noto Serif TC", serif; 
            font-size: 0.8rem;
            background: white; 
            border: 1px solid #dcd6cc; 
            padding: 4px;
            min-height: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: grab; 
            white-space: nowrap;

            /* ⭐ 備選區星曜也改為直書 */
            writing-mode: vertical-rl;
            text-orientation: upright;
        }

        /* 中宮資訊 */
        .info-row { font-size: 0.75rem; margin-bottom: 2px; }
        .info-label { width: 3.5em; font-weight: bold; color: #57534e; }
        
    </style>
</head>
<body class="main-container font-sans bg-paper-bg text-ink-main">

    <!-- 側邊欄 -->
    <aside class="w-full md:w-80 bg-paper-panel border-b md:border-b-0 md:border-r border-paper-border flex flex-col shadow-xl z-20 flex-shrink-0" style="max-height: 100vh;">
        <div class="p-3 border-b border-paper-border bg-white flex items-center justify-between flex-shrink-0">
            <div>
                <h1 class="text-xl font-serif text-accent-gold font-bold tracking-widest">紫微斗數</h1>
                <p class="text-[10px] text-ink-sub tracking-wider">專業疊宮 v7</p>
            </div>
        </div>

        <div class="p-2 border-b border-paper-border bg-gray-50 flex-shrink-0">
            <div class="flex bg-gray-200 rounded p-1 gap-1" id="layerTabs">
                <div class="flex-1 text-center py-1 text-xs font-bold cursor-pointer rounded bg-white text-green-700 shadow-sm layer-tab" data-layer="ben">本命</div>
                <div class="flex-1 text-center py-1 text-xs font-bold cursor-pointer text-gray-500 hover:bg-white/50 layer-tab" data-layer="da">大限</div>
                <div class="flex-1 text-center py-1 text-xs font-bold cursor-pointer text-gray-500 hover:bg-white/50 layer-tab" data-layer="nian">流年</div>
                <div class="flex-1 text-center py-1 text-xs font-bold cursor-pointer text-gray-500 hover:bg-white/50 layer-tab" data-layer="yue">流月</div>
                <div class="flex-1 text-center py-1 text-xs font-bold cursor-pointer text-gray-500 hover:bg-white/50 layer-tab" data-layer="ri">流日</div>
            </div>
        </div>

        <div class="p-3 border-b border-paper-border bg-white flex-shrink-0 overflow-y-auto custom-scrollbar" style="max-height: 30vh;" id="layerControls"></div>

        <div class="flex-1 overflow-hidden flex flex-col bg-paper-panel min-h-0">
            <div class="p-1.5 bg-gray-200 text-[10px] font-bold text-gray-600 border-b border-gray-300 px-3 flex justify-between items-center flex-shrink-0">
                <span>星曜備選區 (拖曳)</span>
            </div>
            <div id="starPool" class="flex-1 overflow-y-auto star-pool-grid content-start custom-scrollbar"></div>
        </div>

        <div class="p-2 border-t border-paper-border bg-white flex-shrink-0">
            <button onclick="resetAll()" class="w-full py-1.5 border border-gray-300 text-gray-600 rounded hover:bg-gray-100 text-xs font-medium transition-colors">全盤重置</button>
        </div>
    </aside>

    <!-- 主畫面 -->
    <main class="palace-grid-container bg-paper-bg relative">
        <div class="palace-grid shadow-2xl" id="palaceGrid">
            <!-- 中宮 -->
            <div class="center-area">
                <div class="center-decor"></div>
                <div id="centerInfoPanel" class="flex-1 overflow-y-auto custom-scrollbar w-full">
                    <div class="text-center text-gray-400 text-xs mt-4">
                        <p class="font-serif italic">- 點擊宮位查看三合 -</p>
                        <div class="mt-2 flex flex-col gap-1 items-center">
                            <span class="px-2 py-0.5 bg-[#eff6ff] text-blue-600 text-[10px] border border-blue-200 rounded">藍色：本宮/對宮</span>
                            <span class="px-2 py-0.5 bg-[#fefce8] text-yellow-600 text-[10px] border border-yellow-200 rounded">黃色：三合宮位</span>
                        </div>
                    </div>
                </div>
                <div class="w-full flex gap-1 mt-2 flex-shrink-0 pt-2 border-t border-gray-200">
                    <button onclick="exportData()" class="flex-1 py-1 bg-white border border-accent-gold text-accent-gold rounded hover:bg-orange-50 text-[10px]">匯出</button>
                    <label class="flex-1 py-1 bg-accent-gold text-white rounded hover:bg-yellow-700 text-[10px] cursor-pointer text-center">
                        匯入
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                    </label>
                </div>
                <div id="statusMsg" class="text-[10px] text-gray-400 h-3 font-sans text-center mt-0.5"></div>
            </div>
        </div>
    </main>

    <script>
        // --- 資料定義 ---
        const tianganList = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const earthBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const branchesList = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        
        const sihuaTable = {
            '甲': { lu: '廉貞', quan: '破軍', ke: '武曲', ji: '太陽' },
            '乙': { lu: '天機', quan: '天梁', ke: '紫微', ji: '太陰' },
            '丙': { lu: '天同', quan: '天機', ke: '文昌', ji: '廉貞' },
            '丁': { lu: '太陰', quan: '天同', ke: '天機', ji: '巨門' },
            '戊': { lu: '貪狼', quan: '太陰', ke: '右弼', ji: '天機' },
            '己': { lu: '武曲', quan: '貪狼', ke: '天梁', ji: '文曲' },
            '庚': { lu: '太陽', quan: '武曲', ke: '太陰', ji: '天相' },
            '辛': { lu: '巨門', quan: '太陽', ke: '文曲', ji: '文昌' },
            '壬': { lu: '天梁', quan: '紫微', ke: '左輔', ji: '武曲' },
            '癸': { lu: '破軍', quan: '巨門', ke: '太陰', ji: '貪狼' }
        };

        const gridLayout = [
            '巳', '午', '未', '申',
            '辰', 'XXX', 'XXX', '酉',
            '卯', 'XXX', 'XXX', '戌',
            '寅', '丑', '子', '亥'
        ];

        const palaceNamesTemplate = ['命宮', '兄弟', '夫妻', '子女', '財帛', '疾厄', '遷移', '交友', '官祿', '田宅', '福德', '父母'];

        const layers = {
            ben: { label: '本命', colorClass: 'label-ben', bgClass: 'bg-ben', prefix: '' },
            da:  { label: '大限', colorClass: 'label-da',  bgClass: 'bg-da',  prefix: '大' },
            nian:{ label: '流年', colorClass: 'label-nian',bgClass: 'bg-nian',prefix: '年' },
            yue: { label: '流月', colorClass: 'label-yue', bgClass: 'bg-yue', prefix: '月' },
            ri:  { label: '流日', colorClass: 'label-ri',  bgClass: 'bg-ri',  prefix: '日' }
        };

        // 星曜分類
        const starsData = [
            { name: '紫微', type: 'major' }, { name: '天機', type: 'major' }, { name: '太陽', type: 'major' }, 
            { name: '武曲', type: 'major' }, { name: '天同', type: 'major' }, { name: '廉貞', type: 'major' },
            { name: '天府', type: 'major' }, { name: '太陰', type: 'major' }, { name: '貪狼', type: 'major' }, 
            { name: '巨門', type: 'major' }, { name: '天相', type: 'major' }, { name: '天梁', type: 'major' }, 
            { name: '七殺', type: 'major' }, { name: '破軍', type: 'major' },
            { name: '天魁', type: 'blue' }, { name: '天鉞', type: 'blue' }, { name: '左輔', type: 'blue' }, { name: '右弼', type: 'blue' },
            { name: '文昌', type: 'green' }, { name: '文曲', type: 'green' }, { name: '祿存', type: 'green' }, { name: '天馬', type: 'green' },
            { name: '紅鸞', type: 'pink' }, { name: '天喜', type: 'pink' }, { name: '天姚', type: 'pink' },
            { name: '地空', type: 'black_bg' }, { name: '地劫', type: 'black_bg' },
            { name: '擎羊', type: 'gray_bg' }, { name: '陀羅', type: 'gray_bg' }, { name: '火星', type: 'gray_bg' }, { name: '鈴星', type: 'gray_bg' },
            { name: '天刑', type: 'gray_bg' } 
        ];

        let appState = {
            starPositions: {}, 
            layers: {
                ben: { tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' },
                da:  { tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' },
                nian:{ tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' },
                yue: { tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' },
                ri:  { tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' }
            }
        };

        let currentTab = 'ben';

        function getStarClass(name) {
            const star = starsData.find(s => s.name === name);
            if (!star) return 'text-gray-800';
            switch (star.type) {
                case 'major': return 'style-major';
                case 'blue': return 'style-blue';
                case 'green': return 'style-green';
                case 'pink': return 'style-pink';
                case 'black_bg': return 'style-black-bg';
                case 'gray_bg': return 'style-gray-bg';
                default: return 'text-gray-800';
            }
        }

        // --- 初始化 ---
        function init() {
            starsData.forEach(s => appState.starPositions[s.name] = 'pool');
            buildGrid();
            renderStarPool();
            setupTabs();
            renderControlPanel();

            // 備選區可作為回收拖曳區
            setupStarPoolDropZone();
        }

        function setupStarPoolDropZone() {
            const pool = document.getElementById('starPool');
            if (!pool) return;

            pool.addEventListener('dragover', (e) => {
                e.preventDefault();
                pool.style.backgroundColor = '#fefce8';
            });

            pool.addEventListener('dragleave', () => {
                pool.style.backgroundColor = '';
            });

            pool.addEventListener('drop', (e) => {
                e.preventDefault();
                pool.style.backgroundColor = '';

                const starName = e.dataTransfer.getData('text/plain');
                if (!starName) return;

                appState.starPositions[starName] = 'pool';
                renderStars();
            });
        }

        function buildGrid() {
            const grid = document.getElementById('palaceGrid');
            const center = grid.querySelector('.center-area');
            grid.innerHTML = '';
            
            gridLayout.forEach(branch => {
                if (branch === 'XXX') {
                    if (!grid.contains(center)) grid.appendChild(center);
                    return;
                }

                const cell = document.createElement('div');
                cell.className = 'palace-cell';
                cell.dataset.branch = branch;
                
                cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.style.backgroundColor = '#fafaf9'; });
                cell.addEventListener('dragleave', () => cell.style.backgroundColor = '');
                cell.addEventListener('drop', handleDrop);
                cell.addEventListener('click', () => {
                    handlePalaceClick(branch);
                });

                const header = document.createElement('div');
                header.className = 'palace-header';
                header.id = `header-${branch}`;
                cell.appendChild(header);

                const starCont = document.createElement('div');
                starCont.className = 'palace-stars';
                starCont.id = `stars-${branch}`;
                cell.appendChild(starCont);

                const water = document.createElement('div');
                water.className = 'branch-watermark';
                water.textContent = branch;
                cell.appendChild(water);

                const corner = document.createElement('div');
                corner.className = 'corner-branch';
                corner.textContent = branch; 
                cell.appendChild(corner);

                grid.appendChild(cell);
            });
        }

        // --- UI 事件 ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.layer-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('bg-white', 'text-green-700', 'text-blue-700', 'text-red-700', 'text-purple-700', 'text-orange-700', 'shadow-sm');
                        t.classList.add('text-gray-500');
                    });
                    
                    const layer = tab.dataset.layer;
                    const colors = {
                        'ben': 'text-green-700', 'da': 'text-blue-700', 'nian': 'text-red-700', 
                        'yue': 'text-purple-700', 'ri': 'text-orange-700'
                    };
                    tab.classList.remove('text-gray-500');
                    tab.classList.add('bg-white', colors[layer], 'shadow-sm');
                    
                    currentTab = layer;
                    renderControlPanel();
                });
            });
        }

        function renderControlPanel() {
            const container = document.getElementById('layerControls');
            const layerKey = currentTab;
            const config = layers[layerKey];
            const data = appState.layers[layerKey];

            const colorMap = {
                'ben': 'text-green-700', 'da': 'text-blue-700', 'nian': 'text-red-700', 
                'yue': 'text-purple-700', 'ri': 'text-orange-700'
            };
            const titleColor = colorMap[layerKey];

            container.innerHTML = `
                <div class="space-y-4 animate-fade-in">
                    <div class="flex items-center justify-between border-b pb-2">
                        <span class="text-sm font-bold ${titleColor} flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                            ${config.label}設定
                        </span>
                        <button onclick="clearLayer('${layerKey}')" class="text-[10px] text-gray-400 hover:text-red-500 underline decoration-dotted">清除</button>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-gray-500">1. 設定命宮</label>
                        <select onchange="setLayerMing('${layerKey}', this.value)" class="w-full text-xs border-gray-300 rounded shadow-sm p-1.5 bg-gray-50">
                            <option value="">(未設定)</option>
                            ${earthBranches.map(b => `<option value="${b}" ${data.mingBranch === b ? 'selected' : ''}>${b}宮</option>`).join('')}
                        </select>
                    </div>

                    <div class="space-y-2 bg-gray-50 p-2 rounded border border-gray-200">
                        <div class="flex justify-between items-center">
                            <label class="block text-[10px] font-bold text-gray-700">2. 設定天干 (排四化)</label>
                        </div>
                        
                        <select onchange="setLayerTiangan('${layerKey}', this.value)" class="w-full text-xs border-accent-gold rounded p-1 text-center bg-white">
                            <option value="">-- 天干 --</option>
                            ${tianganList.map(t => `<option value="${t}" ${data.tiangan === t ? 'selected' : ''}>${t} (${getSihuaString(t)})</option>`).join('')}
                        </select>

                        <div class="grid grid-cols-4 gap-1 mt-1">
                            ${['lu', 'quan', 'ke', 'ji'].map(type => {
                                const typeLabel = type === 'lu' ? '祿' : type === 'quan' ? '權' : type === 'ke' ? '科' : '忌';
                                const badgeColorClass = type === 'lu' ? 'bg-green-600' : type === 'quan' ? 'bg-purple-600' : type === 'ke' ? 'bg-blue-600' : 'bg-red-600';
                                
                                return `
                                <div class="flex flex-col gap-0.5">
                                    <span class="text-[9px] text-center text-white ${badgeColorClass} rounded-sm">${typeLabel}</span>
                                    <select onchange="setLayerSihua('${layerKey}', '${type}', this.value)" class="w-full text-[9px] border-gray-300 rounded p-0.5 h-5">
                                        <option value="">無</option>
                                        ${starsData.map(s => `<option value="${s.name}" ${data[type] === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                                    </select>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getSihuaString(t) {
            if(!sihuaTable[t]) return '';
            const s = sihuaTable[t];
            return `${s.lu.substring(0,1)}${s.quan.substring(0,1)}${s.ke.substring(0,1)}${s.ji.substring(0,1)}`;
        }

        // --- 核心操作 ---

        function handlePalaceClick(branch) {
            document.querySelectorAll('.palace-cell').forEach(c => {
                c.classList.remove('highlight-target', 'highlight-dui', 'highlight-sanhe');
            });

            const targetCell = document.querySelector(`.palace-cell[data-branch="${branch}"]`);
            if(targetCell) targetCell.classList.add('highlight-target');

            const duiBranch = getDuiGong(branch);
            const duiCell = document.querySelector(`.palace-cell[data-branch="${duiBranch}"]`);
            if(duiCell) duiCell.classList.add('highlight-dui');

            const relations = getRelations(branch);
            relations.sanhe.forEach(sanBranch => {
                const sanCell = document.querySelector(`.palace-cell[data-branch="${sanBranch}"]`);
                if(sanCell) sanCell.classList.add('highlight-sanhe');
            });

            updateCenterInfo(branch);
        }

        function setLayerMing(layerKey, branch) {
            appState.layers[layerKey].mingBranch = branch;
            updatePalaceLabels();
            if (currentTab === layerKey) renderControlPanel();
        }

        function setLayerTiangan(layerKey, tiangan) {
            appState.layers[layerKey].tiangan = tiangan;
            if (tiangan && sihuaTable[tiangan]) {
                const s = sihuaTable[tiangan];
                appState.layers[layerKey].lu = s.lu;
                appState.layers[layerKey].quan = s.quan;
                appState.layers[layerKey].ke = s.ke;
                appState.layers[layerKey].ji = s.ji;
            }
            renderStars();
            renderControlPanel();
        }

        function setLayerSihua(layerKey, type, starName) {
            appState.layers[layerKey][type] = starName;
            renderStars();
        }

        function clearLayer(layerKey) {
            if(!confirm(`確定清除?`)) return;
            appState.layers[layerKey] = { tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' };
            renderControlPanel();
            updatePalaceLabels();
            renderStars();
        }

        function resetAll() {
            if(!confirm("確定要全盤重置？")) return;
            starsData.forEach(s => appState.starPositions[s.name] = 'pool');
            Object.keys(appState.layers).forEach(k => {
                appState.layers[k] = { tiangan: '', mingBranch: '', lu: '', quan: '', ke: '', ji: '' };
            });
            renderStarPool();
            renderStars();
            updatePalaceLabels();
            renderControlPanel();
            document.getElementById('centerInfoPanel').innerHTML = '<div class="text-center text-gray-400 text-xs mt-4"><p class="font-serif italic">- 點擊宮位查看三合 -</p></div>';
            document.querySelectorAll('.palace-cell').forEach(c => c.classList.remove('highlight-target', 'highlight-dui', 'highlight-sanhe'));
        }

        // --- 輔助計算 ---

        function updateCenterInfo(clickedBranch) {
            const panel = document.getElementById('centerInfoPanel');
            const relations = getRelations(clickedBranch);
            const duiBranch = getDuiGong(clickedBranch);

            const getStars = (branch) => {
                const stars = starsData
                    .filter(s => appState.starPositions[s.name] === branch)
                    .map(s => s.name);
                return stars.length > 0 ? stars.join(' ') : '無';
            };

            let html = `
                <div class="text-center mb-2 border-b border-gray-200 pb-1">
                    <span class="text-sm font-bold font-serif text-accent-gold">${clickedBranch}位 關聯</span>
                </div>
            `;

            html += `<div class="mb-1"><div class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1 rounded inline-block">本宮</div> <span class="text-xs font-serif">${getStars(clickedBranch)}</span></div>`;
            html += `<div class="mb-1"><div class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1 rounded inline-block">對宮</div> <span class="text-xs text-gray-600">${duiBranch}:</span> <span class="text-xs font-serif">${getStars(duiBranch)}</span></div>`;

            relations.sanhe.forEach(b => {
                 html += `<div class="mb-1"><div class="text-[10px] font-bold text-yellow-600 bg-yellow-50 px-1 rounded inline-block">三合</div> <span class="text-xs text-gray-600">${b}:</span> <span class="text-xs font-serif">${getStars(b)}</span></div>`;
            });

            panel.innerHTML = html;
        }

        function getRelations(branch) {
            const idx = branchesList.indexOf(branch);
            const p1 = branchesList[(idx + 4) % 12];
            const p2 = branchesList[(idx + 8) % 12];
            const anheMap = { '子':'丑','丑':'子','寅':'亥','亥':'寅','卯':'戌','戌':'卯','辰':'酉','酉':'辰','巳':'申','申':'巳','午':'未','未':'午' };
            return { sanhe: [p1, p2], anhe: anheMap[branch] };
        }

        function getDuiGong(branch) {
             const idx = branchesList.indexOf(branch);
             return branchesList[(idx + 6) % 12];
        }

        // --- 渲染 ---

        function updatePalaceLabels() {
            document.querySelectorAll('.palace-header').forEach(h => h.innerHTML = '');

            Object.keys(layers).forEach(layerKey => {
                const config = layers[layerKey];
                const mingBranch = appState.layers[layerKey].mingBranch;
                if (!mingBranch) return;

                const mingIdx = earthBranches.indexOf(mingBranch);
                earthBranches.forEach((branch, idx) => {
                    const branchIdx = earthBranches.indexOf(branch);
                    let offset = (mingIdx - branchIdx + 12) % 12;
                    const name = palaceNamesTemplate[offset];
                    let displayText = name;
                    
                    if (layerKey !== 'ben') {
                         displayText = config.prefix + name.substring(0, 1);
                         if(name === '命宮') displayText = config.prefix + "命";
                    }

                    const labelDiv = document.createElement('span');
                    labelDiv.className = `palace-label ${config.colorClass}`;
                    labelDiv.textContent = displayText;
                    
                    const header = document.getElementById(`header-${branch}`);
                    if (header) header.appendChild(labelDiv);
                });
            });
        }

        function renderStars() {
            document.querySelectorAll('.palace-stars').forEach(el => el.innerHTML = '');
            document.getElementById('starPool').innerHTML = '';

            starsData.forEach(star => {
                const pos = appState.starPositions[star.name];
                const starEl = createStarGroup(star, pos === 'pool');

                if (pos === 'pool') {
                    document.getElementById('starPool').appendChild(starEl);
                } else {
                    const container = document.getElementById(`stars-${pos}`);
                    if (container) container.appendChild(starEl);
                }
            });
            
            const selected = document.querySelector('.palace-cell.highlight-target');
            if(selected) updateCenterInfo(selected.dataset.branch);
        }

        function renderStarPool() { renderStars(); }

        function createStarGroup(star, isPool) {
            if (isPool) {
                const el = document.createElement('div');
                el.className = `star-pool-item type-${star.type}`;
                el.draggable = true;
                el.textContent = star.name;
                el.dataset.name = star.name;
                
                const colorClass = getStarClass(star.name);
                if(colorClass.includes('style-')) el.classList.add(colorClass);

                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dblclick', () => { appState.starPositions[star.name] = 'pool'; renderStars(); });
                return el;
            }

            const group = document.createElement('div');
            group.className = 'star-group';
            group.draggable = true;
            group.dataset.name = star.name;

            // 星曜名稱
            const nameSpan = document.createElement('span');
            nameSpan.className = `star-item ${getStarClass(star.name)}`;
            nameSpan.textContent = star.name;
            group.appendChild(nameSpan);

            // 四化容器
            const badgeContainer = document.createElement('span');
            badgeContainer.className = 'sihua-container';
            
            Object.keys(layers).forEach(layerKey => {
                const lData = appState.layers[layerKey];
                const map = { lu: '祿', quan: '權', ke: '科', ji: '忌' };
                const borderColors = { ben: 'border-ben', da: 'border-da', nian: 'border-nian', yue: 'border-yue', ri: 'border-ri' };
                const textColors = { lu: 'text-lu', quan: 'text-quan', ke: 'text-ke', ji: 'text-ji' };
                const layerPrefix = { ben: '生', da: '大', nian: '年', yue: '月', ri: '日' };

                Object.keys(map).forEach(type => {
                    if (lData[type] === star.name) {
                        const badge = document.createElement('span');
                        badge.className = `sihua-tag ${borderColors[layerKey]} ${textColors[type]}`;
                        badge.dataset.layer = layerPrefix[layerKey];
                        badge.textContent = map[type];
                        badgeContainer.appendChild(badge);
                    }
                });
            });
            
            if (badgeContainer.children.length > 0) {
                group.appendChild(badgeContainer);
            }

            group.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', star.name);
                group.querySelector('.star-item').classList.add('dragging');
            });
            group.addEventListener('dragend', () => group.querySelector('.star-item').classList.remove('dragging'));

            return group;
        }

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.name);
            e.target.classList.add('opacity-50');
        }
        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.style.backgroundColor = '';
            
            const starName = e.dataTransfer.getData('text/plain');
            if (!starName) return;
            const targetBranch = this.dataset.branch;
            
            appState.starPositions[starName] = targetBranch;
            renderStars();
        }

        // --- 匯出匯入 ---
        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0,10);
            a.download = `紫微斗數排盤_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showStatus("匯出成功");
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedState = JSON.parse(e.target.result);
                    if (!loadedState.starPositions || !loadedState.layers) throw new Error();
                    appState = loadedState;
                    renderStars();
                    updatePalaceLabels();
                    renderControlPanel();
                    showStatus("匯入成功");
                } catch (err) { alert("格式錯誤"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function showStatus(msg) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            setTimeout(() => el.textContent = '', 3000);
        }

        init();
    </script>
</body>
</html>
